id: ADR-019
type: decision
title: "Document Enrichment Architecture"
status: accepted
date: "2026-01-23"
supersedes: null
deprecated_by: null

context: |
  O SDLC Agêntico possui um corpus RAG com documentos de referência (PDFs, specs, whitepapers)
  que são indexados mas permanecem estáticos. Quando agentes de pesquisa realizam
  buscas sobre tópicos relacionados, há duplicação de esforço e perda de conhecimento:

  Problema 1: Agentes researching topics já cobertos em docs não leverageiam conhecimento existente
  Problema 2: Documentos ficam desatualizados (OAuth 2.0 spec não menciona OAuth 2.1)
  Problema 3: Não há versionamento de conhecimento evolutivo sobre um tópico
  Problema 4: Graph não captura relação entre research findings e docs originais

decision: |
  Implementar sistema de enriquecimento automático de documentos que:

  1. DETECTION: Durante research, verifica docs relacionados (similarity >= 0.6)
  2. EXTRACTION: Extrai conteúdo do documento original (via document-processor)
  3. MERGE: Combina original + research findings em documento enriquecido
  4. VERSIONING: Cria .enriched.vN.md (v1, v2, v3...) preservando original
  5. INDEXING: Cria corpus node ENRICH-{id}.yml com metadata completo
  6. GRAPH: Adiciona relação 'enriches' ligando enrichment ao doc original

  Abordagem Híbrida: Nova skill + Modificação de agentes de research
  - skill: document-enricher (lógica core, scripts, templates)
  - agents: Step 0 pré-research em 5 agentes (domain-researcher, doc-crawler, etc.)

alternatives:
  - option: "Opção 1: Modificar apenas agentes (sem skill separada)"
    pros:
      - "Menos arquivos"
      - "Lógica inline nos agentes"
    cons:
      - "Duplicação de código em 5 agentes"
      - "Difícil de testar e manter"
      - "Sem reusabilidade"
    rejected_reason: "Viola DRY, dificulta testes e manutenção"

  - option: "Opção 2: Skill pura sem modificar agentes (manual only)"
    pros:
      - "Skill isolada e testável"
      - "Agentes não modificados"
    cons:
      - "Não é automático"
      - "Usuário precisa lembrar de usar /doc-enrich"
      - "Baixa adoption rate"
    rejected_reason: "Não atende requisito de automação transparente"

  - option: "Opção 3: Hook automático em todas tools (muito invasivo)"
    pros:
      - "Completamente automático"
    cons:
      - "Performance overhead em TODAS tools"
      - "Detecção de research vs. outros tipos de tools complexa"
      - "Muito acoplado ao sistema de hooks"
    rejected_reason: "Performance impact e complexidade excessivos"

consequences:
  positive:
    - "Documentos evoluem com o tempo (conhecimento cumulativo)"
    - "Originais preservados (imutáveis)"
    - "Rastreabilidade completa (sources, dates, agent)"
    - "Graph-indexed (descoberta de enrichments relacionados)"
    - "Transparente para usuário (automático)"
    - "Testável (37 testes unitários + integração)"

  negative:
    - "Modificação em 5 agentes (manutenção adicional)"
    - "Storage cresce com enrichments (mitigado por decay scoring)"
    - "Possibilidade de false positives (similarity 0.6 pode ser baixo)"

  neutral:
    - "Novo workflow para agentes (Step 0 adiciona overhead mínimo)"
    - "Quality gate adicional (enrichment-quality.yml)"

trade_offs:
  - aspect: "Automação vs. Controle"
    chosen: "Automação com threshold configurável (ENRICHMENT_MIN_SIMILARITY)"
    rationale: "Usuário pode ajustar threshold se muitos false positives/negatives"

  - aspect: "Originalidade vs. Enriquecimento"
    chosen: "Imutabilidade do original + versões enriquecidas separadas"
    rationale: "Preserva fonte confiável, permite experimentação com enrichments"

  - aspect: "Performance vs. Completude"
    chosen: "Busca otimizada (hybrid search) com cache de similarities"
    rationale: "Latência < 200ms para 1000 docs, aceitável para Step 0"

  - aspect: "Storage vs. Histórico"
    chosen: "Versioning ilimitado com auto-archive > 1 ano"
    rationale: "Conhecimento recente mais importante, archive previne bloat"

implementation_notes:
  similarity_algorithm: |
    Hybrid score:
    similarity = 0.40 * keyword_overlap (Jaccard)
               + 0.30 * title_similarity (text overlap)
               + 0.20 * summary_similarity (text overlap)
               + 0.10 * category_match (exact match)

    Threshold: 0.6 (configurável)
    Rationale: Balanceia precision (evitar false positives) com recall (não perder matches)

  directory_structure: |
    .agentic_sdlc/
    ├── references/
    │   ├── _index.yml (metadata + enrichment history)
    │   └── technical/
    │       ├── oauth2-spec.pdf (IMMUTABLE)
    │       ├── oauth2-spec.enriched.v1.md
    │       └── oauth2-spec.enriched.v2.md
    └── corpus/
        ├── nodes/learnings/
        │   ├── ENRICH-001.yml
        │   └── ENRICH-002.yml
        └── graph.json (enriches relations)

  versioning_strategy: |
    - Version increments per document (not global)
    - DOC-001 pode ter v1, v2, v3
    - DOC-002 pode ter v1 apenas
    - Max 10 versions por documento (ENRICHMENT_MAX_VERSIONS)
    - Versões antigas auto-archived após 1 ano (ENRICHMENT_AUTO_ARCHIVE)

  quality_gates: |
    enrichment-quality.yml valida:
    - CRITICAL: enrichment_has_sources (research findings citam fontes)
    - CRITICAL: original_preserved (SHA256 hash check)
    - CRITICAL: graph_relation_created (relação 'enriches' existe)
    - WARNING: enrichment_version_incremented (sequencial)
    - WARNING: synthesis_quality (combina original + research coerentemente)

  error_handling: |
    - Document extraction fails → Log warning, continue research only (no enrichment)
    - Similarity computation timeout → Skip enrichment this time
    - Graph update fails → Retry 3x, então create orphan enrichment (fix later)
    - Markdown generation fails → Save raw YAML node only

testing_coverage: |
  37 tests (100% passing):
  - test_find_related.py: 17 tests (keyword extraction, similarity, document search)
  - test_enrich.py: 13 tests (ID generation, versioning, synthesis, Markdown)
  - test_update_index.py: 8 tests (index updates, graph updates, integrity validation)
  - test_integration.py: 3 tests (end-to-end workflow, multiple enrichments)

scalability_considerations: |
  - Similarity search: O(n) atualmente, OK para < 10k docs
  - Future: Embeddings + FAISS index quando corpus > 10k docs
  - Cache de similarity computations (15min TTL)
  - Parallel processing se batch enrichment necessário

security_considerations: |
  - Original documents read-only (filesystem permissions)
  - Enrichments não podem modificar originals (path validation)
  - Sources em enrichments não são executados (apenas URLs armazenadas)
  - No code execution em synthesis (simple text merge)

dependencies:
  - document-processor: Document content extraction (optional, graceful fallback)
  - graph-navigator: Graph structure and relations
  - rag-query: Hybrid search functionality
  - decay-scoring: Freshness tracking for enrichments

migration_path: |
  Existing documents não requerem migração:
  - _index.yml tem schema backward-compatible (enrichments é campo opcional)
  - Documents sem enrichments continuam funcionando
  - Enrichment é opt-in automaticamente (só acontece quando similarity match)

rollback_strategy: |
  Se enrichment causar issues:
  1. Desabilitar: ENRICHMENT_MIN_SIMILARITY=1.0 (threshold impossível)
  2. Remover enrichments:
     - rm .agentic_sdlc/references/**/*.enriched.*.md
     - rm .agentic_sdlc/corpus/nodes/learnings/ENRICH-*.yml
  3. Rebuild graph:
     - python3 .claude/skills/graph-navigator/scripts/graph_builder.py --rebuild
  4. Revert agent modifications se necessário

future_enhancements:
  v2_0:
    - "Embeddings-based semantic search (FAISS)"
    - "Multi-document synthesis (combine 2+ docs)"
    - "Automatic re-enrichment on document updates"
  v2_1:
    - "LLM-powered synthesis generation (via Claude API)"
    - "Conflict detection between original and research"
    - "Enrichment suggestions to users"
  v2_2:
    - "Web UI para visualizar enrichment history"
    - "Diff view entre versões de enrichments"
    - "Collaborative enrichments (multiple agents contributing)"

related_decisions:
  - "ADR-004: RAG Corpus Structure"
  - "ADR-012: Semantic Knowledge Graph"
  - "ADR-015: Decay Scoring System"

tags:
  - document-enrichment
  - knowledge-management
  - research-automation
  - versioning
  - hybrid-search

validation:
  test_coverage: "100% (37/37 tests passing)"
  code_review: "3 commits reviewed"
  quality_gate: "enrichment-quality.yml passing"
  integration: "Tested with domain-researcher, doc-crawler, adr-author"
