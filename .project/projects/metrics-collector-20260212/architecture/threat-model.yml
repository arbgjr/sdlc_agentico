---
# Threat Model - GitHub Metrics Collector
# Generated by: threat-modeler
# Phase: 3 (Architecture)
# Date: 2026-02-12T20:55:33Z
# Methodology: STRIDE

threat_model:
  project: "metrics-collector-20260212"
  version: "1.0"
  created_at: "2026-02-12T20:55:33Z"
  created_by: "threat-modeler"
  methodology: "STRIDE"

  system_overview:
    description: |
      Sistema de coleta automatizada de metricas GitHub (Copilot, DORA, Velocity)
      de 2 enterprises para consumo no PowerBI via Import Mode.

    data_classification:
      - type: "Metricas de uso Copilot"
        sensitivity: "INTERNAL"
        pii: false
        notes: "Dados agregados e por usuario, sem codigo"

      - type: "Metricas de repositorios"
        sensitivity: "INTERNAL"
        pii: false
        notes: "Commits, PRs, workflows - metadados apenas"

      - type: "Credenciais (PATs)"
        sensitivity: "SECRET"
        pii: false
        notes: "Personal Access Tokens com acesso enterprise"

      - type: "Dados de desenvolvedores"
        sensitivity: "INTERNAL"
        pii: true
        notes: "Nomes de usuarios, emails (publicos no GitHub)"

    trust_boundaries:
      - name: "Internet → Azure Functions"
        description: "Funcoes acessam APIs externas via HTTPS"

      - name: "Azure Functions → PostgreSQL"
        description: "Conexao via private endpoint ou firewall rules"

      - name: "Azure Functions → Key Vault"
        description: "Acesso via Managed Identity"

      - name: "Azure Functions → SharePoint"
        description: "Upload via Microsoft Graph API"

  assets:
    - id: "A1"
      name: "GitHub PATs"
      description: "Personal Access Tokens com acesso enterprise"
      value: "CRITICAL"
      location: "Azure Key Vault"

    - id: "A2"
      name: "Metricas coletadas"
      description: "Dados de Copilot, DORA, Velocity"
      value: "HIGH"
      location: "PostgreSQL, SharePoint"

    - id: "A3"
      name: "Conexao PostgreSQL"
      description: "Connection string do banco"
      value: "HIGH"
      location: "Azure Key Vault"

    - id: "A4"
      name: "Credenciais SharePoint"
      description: "Client secret para Graph API"
      value: "HIGH"
      location: "Azure Key Vault"

  threat_analysis:
    # SPOOFING
    - id: "T1"
      category: "Spoofing"
      threat: "Atacante usa PAT roubado para acessar GitHub APIs"
      affected_assets: ["A1"]
      likelihood: "MEDIUM"
      impact: "HIGH"
      risk_score: "HIGH"
      mitigations:
        - id: "M1.1"
          description: "Armazenar PATs exclusivamente no Azure Key Vault"
          status: "PLANNED"
          priority: "P1"
        - id: "M1.2"
          description: "Usar Managed Identity para acesso ao Key Vault"
          status: "PLANNED"
          priority: "P1"
        - id: "M1.3"
          description: "Rotacao de PATs a cada 90 dias"
          status: "PLANNED"
          priority: "P2"
        - id: "M1.4"
          description: "Audit logs de acesso ao Key Vault"
          status: "PLANNED"
          priority: "P2"

    - id: "T2"
      category: "Spoofing"
      threat: "Atacante personifica a aplicacao para coletar dados"
      affected_assets: ["A2"]
      likelihood: "LOW"
      impact: "MEDIUM"
      risk_score: "MEDIUM"
      mitigations:
        - id: "M2.1"
          description: "Funcoes nao tem endpoints publicos (timer trigger)"
          status: "BY_DESIGN"
          priority: "N/A"

    # TAMPERING
    - id: "T3"
      category: "Tampering"
      threat: "Atacante modifica dados em transito para PostgreSQL"
      affected_assets: ["A2"]
      likelihood: "LOW"
      impact: "HIGH"
      risk_score: "MEDIUM"
      mitigations:
        - id: "M3.1"
          description: "Conexao SSL/TLS obrigatoria para PostgreSQL"
          status: "PLANNED"
          priority: "P1"
        - id: "M3.2"
          description: "Private endpoint para banco (opcional)"
          status: "DEFERRED"
          priority: "P3"

    - id: "T4"
      category: "Tampering"
      threat: "Atacante modifica CSVs no SharePoint"
      affected_assets: ["A2"]
      likelihood: "LOW"
      impact: "MEDIUM"
      risk_score: "LOW"
      mitigations:
        - id: "M4.1"
          description: "Permissoes restritas no SharePoint (apenas app pode escrever)"
          status: "PLANNED"
          priority: "P2"
        - id: "M4.2"
          description: "Versioning habilitado no SharePoint"
          status: "PLANNED"
          priority: "P3"

    # REPUDIATION
    - id: "T5"
      category: "Repudiation"
      threat: "Impossivel rastrear quem/quando coletou dados"
      affected_assets: ["A2"]
      likelihood: "MEDIUM"
      impact: "MEDIUM"
      risk_score: "MEDIUM"
      mitigations:
        - id: "M5.1"
          description: "Tabela collection_runs com audit trail"
          status: "PLANNED"
          priority: "P1"
        - id: "M5.2"
          description: "Application Insights com logs estruturados"
          status: "PLANNED"
          priority: "P1"
        - id: "M5.3"
          description: "Retencao de logs por 1 ano"
          status: "PLANNED"
          priority: "P2"

    # INFORMATION DISCLOSURE
    - id: "T6"
      category: "Information Disclosure"
      threat: "PATs expostos em logs ou codigo"
      affected_assets: ["A1"]
      likelihood: "MEDIUM"
      impact: "CRITICAL"
      risk_score: "CRITICAL"
      mitigations:
        - id: "M6.1"
          description: "NUNCA logar valores de secrets"
          status: "REQUIREMENT"
          priority: "P1"
        - id: "M6.2"
          description: "Secrets carregados do Key Vault em runtime"
          status: "PLANNED"
          priority: "P1"
        - id: "M6.3"
          description: "Git pre-commit hook para detectar secrets"
          status: "PLANNED"
          priority: "P2"
        - id: "M6.4"
          description: "GitHub secret scanning habilitado"
          status: "PLANNED"
          priority: "P2"

    - id: "T7"
      category: "Information Disclosure"
      threat: "Acesso nao autorizado ao banco de dados"
      affected_assets: ["A2", "A3"]
      likelihood: "LOW"
      impact: "HIGH"
      risk_score: "MEDIUM"
      mitigations:
        - id: "M7.1"
          description: "Firewall rules - apenas Azure services"
          status: "PLANNED"
          priority: "P1"
        - id: "M7.2"
          description: "Connection string em Key Vault"
          status: "PLANNED"
          priority: "P1"
        - id: "M7.3"
          description: "Usuario DB com minimo privilegio"
          status: "PLANNED"
          priority: "P2"

    # DENIAL OF SERVICE
    - id: "T8"
      category: "Denial of Service"
      threat: "Exceder rate limits do GitHub e bloquear coleta"
      affected_assets: ["A2"]
      likelihood: "MEDIUM"
      impact: "MEDIUM"
      risk_score: "MEDIUM"
      mitigations:
        - id: "M8.1"
          description: "Implementar rate limiting no cliente"
          status: "PLANNED"
          priority: "P1"
        - id: "M8.2"
          description: "Exponential backoff em caso de 429"
          status: "PLANNED"
          priority: "P1"
        - id: "M8.3"
          description: "Monitorar uso de rate limit via headers"
          status: "PLANNED"
          priority: "P2"

    - id: "T9"
      category: "Denial of Service"
      threat: "Funcao Azure timeout antes de completar coleta"
      affected_assets: ["A2"]
      likelihood: "LOW"
      impact: "LOW"
      risk_score: "LOW"
      mitigations:
        - id: "M9.1"
          description: "Dividir coleta em funcoes menores"
          status: "PLANNED"
          priority: "P2"
        - id: "M9.2"
          description: "Premium plan se timeout for problema"
          status: "DEFERRED"
          priority: "P3"

    # ELEVATION OF PRIVILEGE
    - id: "T10"
      category: "Elevation of Privilege"
      threat: "PAT com escopos excessivos permite acoes alem do necessario"
      affected_assets: ["A1"]
      likelihood: "LOW"
      impact: "HIGH"
      risk_score: "MEDIUM"
      mitigations:
        - id: "M10.1"
          description: "Minimo privilegio: apenas escopos necessarios"
          status: "PLANNED"
          priority: "P1"
        - id: "M10.2"
          description: "Documentar escopos necessarios por funcionalidade"
          status: "PLANNED"
          priority: "P2"
        - id: "M10.3"
          description: "Revisar escopos periodicamente"
          status: "PLANNED"
          priority: "P3"

  risk_summary:
    critical: 1
    high: 1
    medium: 6
    low: 2

    highest_risks:
      - threat_id: "T6"
        description: "PATs expostos em logs ou codigo"
        risk_score: "CRITICAL"
        primary_mitigation: "Key Vault + nunca logar secrets"

      - threat_id: "T1"
        description: "PAT roubado usado para acessar APIs"
        risk_score: "HIGH"
        primary_mitigation: "Key Vault + rotacao + audit"

  security_requirements:
    - id: "SEC-001"
      requirement: "Todos os secrets em Azure Key Vault"
      priority: "P1"
      validation: "Nenhum secret em codigo ou config files"

    - id: "SEC-002"
      requirement: "Managed Identity para acesso ao Key Vault"
      priority: "P1"
      validation: "Nenhuma senha/key para acessar Key Vault"

    - id: "SEC-003"
      requirement: "SSL/TLS para todas conexoes"
      priority: "P1"
      validation: "PostgreSQL, Graph API, GitHub API usam HTTPS"

    - id: "SEC-004"
      requirement: "Audit trail de todas coletas"
      priority: "P1"
      validation: "Tabela collection_runs populada a cada execucao"

    - id: "SEC-005"
      requirement: "Principio do minimo privilegio"
      priority: "P1"
      validation: "PATs e DB users com escopos minimos"

    - id: "SEC-006"
      requirement: "Rotacao de credenciais"
      priority: "P2"
      validation: "PATs rotacionados a cada 90 dias"

  compliance_notes:
    - category: "LGPD"
      applicability: "Parcial"
      notes: |
        Dados de desenvolvedores (nomes, emails) sao publicos no GitHub.
        Nao ha coleta de dados sensiveis alem do que ja e publico.
        Recomendado: documentar base legal (interesse legitimo) se necessario.

    - category: "SOC2"
      applicability: "Parcial"
      notes: |
        Se a organizacao requer SOC2, garantir:
        - Audit logs retidos por periodo adequado
        - Controle de acesso documentado
        - Criptografia em transito (SSL/TLS)

  review_schedule:
    initial_review: "2026-02-12"
    next_review: "2026-05-12"
    review_frequency: "Quarterly"
    reviewers:
      - "system-architect"
      - "security-team"

  references:
    - title: "STRIDE Threat Modeling"
      url: "https://docs.microsoft.com/azure/security/develop/threat-modeling-tool"
    - title: "Azure Functions Security"
      url: "https://docs.microsoft.com/azure/azure-functions/security-concepts"
    - title: "GitHub API Security"
      url: "https://docs.github.com/en/rest/overview/other-authentication-methods"

  tags:
    - "security"
    - "threat-model"
    - "stride"
    - "phase-3"
