---
# Data Model Specification
# GitHub Metrics Collector
# Generated by: requirements-analyst
# Phase: 2 (Requirements)
# Date: 2026-02-12T20:39:19Z

data_model:
  version: "1.0"
  database: "Azure SQL Database or PostgreSQL"
  schema_strategy: "schema_per_org"

  schemas:
    - name: "shared"
      description: "Tabelas compartilhadas entre organizacoes"
    - name: "org_{org_id}"
      description: "Schema por organizacao (ex: org_a, org_b)"

  # ========== SHARED SCHEMA ==========
  shared_tables:

    - name: "organizations"
      schema: "shared"
      description: "Organizacoes GitHub monitoradas"
      columns:
        - name: "id"
          type: "VARCHAR(50)"
          primary_key: true
          description: "ID interno da organizacao"
        - name: "github_org_id"
          type: "BIGINT"
          nullable: false
          description: "ID numerico da org no GitHub"
        - name: "github_org_login"
          type: "VARCHAR(100)"
          nullable: false
          description: "Login da org (ex: 'SU-AIOFFICE')"
        - name: "display_name"
          type: "VARCHAR(200)"
          nullable: true
          description: "Nome de exibicao"
        - name: "created_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
        - name: "updated_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["github_org_login"]
          unique: true

    - name: "collection_runs"
      schema: "shared"
      description: "Log de execucoes de coleta"
      columns:
        - name: "id"
          type: "UUID"
          primary_key: true
        - name: "org_id"
          type: "VARCHAR(50)"
          foreign_key: "shared.organizations.id"
        - name: "started_at"
          type: "TIMESTAMP"
          nullable: false
        - name: "completed_at"
          type: "TIMESTAMP"
          nullable: true
        - name: "status"
          type: "VARCHAR(20)"
          description: "running, success, failed, partial"
        - name: "records_collected"
          type: "INT"
          default: 0
        - name: "error_message"
          type: "TEXT"
          nullable: true
        - name: "metrics_type"
          type: "VARCHAR(50)"
          description: "copilot, dora, velocity, all"
      indexes:
        - columns: ["org_id", "started_at"]

  # ========== ORG-SPECIFIC SCHEMA ==========
  org_tables:

    # ----- Copilot Metrics -----
    - name: "copilot_daily_metrics"
      schema: "org_{org_id}"
      description: "Metricas diarias agregadas do Copilot"
      columns:
        - name: "id"
          type: "UUID"
          primary_key: true
        - name: "date"
          type: "DATE"
          nullable: false
        - name: "total_active_users"
          type: "INT"
        - name: "total_suggestions_shown"
          type: "BIGINT"
        - name: "total_suggestions_accepted"
          type: "BIGINT"
        - name: "acceptance_rate"
          type: "DECIMAL(5,4)"
          description: "0.0000 to 1.0000"
        - name: "collected_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["date"]
          unique: true

    - name: "copilot_user_metrics"
      schema: "org_{org_id}"
      description: "Metricas de Copilot por usuario"
      columns:
        - name: "id"
          type: "UUID"
          primary_key: true
        - name: "date"
          type: "DATE"
          nullable: false
        - name: "github_user_id"
          type: "BIGINT"
          nullable: false
        - name: "github_login"
          type: "VARCHAR(100)"
          nullable: false
        - name: "suggestions_shown"
          type: "INT"
        - name: "suggestions_accepted"
          type: "INT"
        - name: "acceptance_rate"
          type: "DECIMAL(5,4)"
        - name: "lines_suggested"
          type: "INT"
        - name: "lines_accepted"
          type: "INT"
        - name: "collected_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["date", "github_user_id"]
          unique: true
        - columns: ["github_login"]

    - name: "copilot_language_metrics"
      schema: "org_{org_id}"
      description: "Metricas de Copilot por linguagem"
      columns:
        - name: "id"
          type: "UUID"
          primary_key: true
        - name: "date"
          type: "DATE"
          nullable: false
        - name: "language"
          type: "VARCHAR(50)"
          nullable: false
        - name: "suggestions_shown"
          type: "INT"
        - name: "suggestions_accepted"
          type: "INT"
        - name: "acceptance_rate"
          type: "DECIMAL(5,4)"
        - name: "collected_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["date", "language"]
          unique: true

    # ----- Repository Info -----
    - name: "repositories"
      schema: "org_{org_id}"
      description: "Repositorios monitorados"
      columns:
        - name: "id"
          type: "BIGINT"
          primary_key: true
          description: "GitHub repo ID"
        - name: "name"
          type: "VARCHAR(200)"
          nullable: false
        - name: "full_name"
          type: "VARCHAR(400)"
          nullable: false
          description: "owner/repo"
        - name: "default_branch"
          type: "VARCHAR(100)"
          default: "'main'"
        - name: "is_active"
          type: "BOOLEAN"
          default: true
        - name: "first_seen_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
        - name: "last_activity_at"
          type: "TIMESTAMP"
          nullable: true
      indexes:
        - columns: ["full_name"]
          unique: true

    # ----- DORA Metrics -----
    - name: "dora_deployments"
      schema: "org_{org_id}"
      description: "Registro de deployments para DORA"
      columns:
        - name: "id"
          type: "UUID"
          primary_key: true
        - name: "repo_id"
          type: "BIGINT"
          foreign_key: "org_{org_id}.repositories.id"
        - name: "workflow_run_id"
          type: "BIGINT"
          nullable: false
        - name: "deployed_at"
          type: "TIMESTAMP"
          nullable: false
        - name: "branch"
          type: "VARCHAR(200)"
        - name: "sha"
          type: "VARCHAR(40)"
        - name: "is_success"
          type: "BOOLEAN"
        - name: "is_rollback"
          type: "BOOLEAN"
          default: false
        - name: "collected_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["repo_id", "deployed_at"]
        - columns: ["workflow_run_id"]
          unique: true

    - name: "dora_weekly_metrics"
      schema: "org_{org_id}"
      description: "Metricas DORA calculadas semanalmente"
      columns:
        - name: "id"
          type: "UUID"
          primary_key: true
        - name: "repo_id"
          type: "BIGINT"
          foreign_key: "org_{org_id}.repositories.id"
        - name: "week_start"
          type: "DATE"
          nullable: false
        - name: "deployment_frequency"
          type: "DECIMAL(10,4)"
          description: "Deploys per day"
        - name: "deployment_frequency_rating"
          type: "VARCHAR(20)"
          description: "Elite, High, Medium, Low"
        - name: "lead_time_hours"
          type: "DECIMAL(10,2)"
          description: "Average lead time in hours"
        - name: "lead_time_p50_hours"
          type: "DECIMAL(10,2)"
        - name: "lead_time_p95_hours"
          type: "DECIMAL(10,2)"
        - name: "lead_time_rating"
          type: "VARCHAR(20)"
        - name: "change_failure_rate"
          type: "DECIMAL(5,4)"
          description: "0.0000 to 1.0000"
        - name: "change_failure_rating"
          type: "VARCHAR(20)"
        - name: "mttr_hours"
          type: "DECIMAL(10,2)"
          nullable: true
        - name: "mttr_rating"
          type: "VARCHAR(20)"
          nullable: true
        - name: "calculated_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["repo_id", "week_start"]
          unique: true

    # ----- Velocity Metrics -----
    - name: "commits"
      schema: "org_{org_id}"
      description: "Registro de commits para Velocity"
      columns:
        - name: "sha"
          type: "VARCHAR(40)"
          primary_key: true
        - name: "repo_id"
          type: "BIGINT"
          foreign_key: "org_{org_id}.repositories.id"
        - name: "author_github_id"
          type: "BIGINT"
          nullable: true
        - name: "author_login"
          type: "VARCHAR(100)"
          nullable: true
        - name: "author_email"
          type: "VARCHAR(200)"
        - name: "committed_at"
          type: "TIMESTAMP"
          nullable: false
        - name: "lines_added"
          type: "INT"
          default: 0
        - name: "lines_deleted"
          type: "INT"
          default: 0
        - name: "is_automated"
          type: "BOOLEAN"
          default: false
          description: "Commit de bot (dependabot, etc)"
        - name: "collected_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["repo_id", "committed_at"]
        - columns: ["author_login"]

    - name: "pull_requests"
      schema: "org_{org_id}"
      description: "Registro de PRs para Velocity"
      columns:
        - name: "id"
          type: "BIGINT"
          primary_key: true
          description: "GitHub PR ID"
        - name: "repo_id"
          type: "BIGINT"
          foreign_key: "org_{org_id}.repositories.id"
        - name: "number"
          type: "INT"
          nullable: false
        - name: "author_github_id"
          type: "BIGINT"
          nullable: true
        - name: "author_login"
          type: "VARCHAR(100)"
        - name: "created_at"
          type: "TIMESTAMP"
          nullable: false
        - name: "merged_at"
          type: "TIMESTAMP"
          nullable: true
        - name: "closed_at"
          type: "TIMESTAMP"
          nullable: true
        - name: "first_commit_at"
          type: "TIMESTAMP"
          nullable: true
        - name: "first_review_at"
          type: "TIMESTAMP"
          nullable: true
        - name: "state"
          type: "VARCHAR(20)"
          description: "open, closed, merged"
        - name: "additions"
          type: "INT"
          default: 0
        - name: "deletions"
          type: "INT"
          default: 0
        - name: "is_self_merged"
          type: "BOOLEAN"
          default: false
        - name: "collected_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["repo_id", "created_at"]
        - columns: ["author_login"]
        - columns: ["merged_at"]

    - name: "velocity_weekly_metrics"
      schema: "org_{org_id}"
      description: "Metricas de Velocity calculadas semanalmente"
      columns:
        - name: "id"
          type: "UUID"
          primary_key: true
        - name: "repo_id"
          type: "BIGINT"
          foreign_key: "org_{org_id}.repositories.id"
          nullable: true
          description: "NULL = all repos aggregated"
        - name: "week_start"
          type: "DATE"
          nullable: false
        - name: "commits_count"
          type: "INT"
        - name: "commits_per_dev_day"
          type: "DECIMAL(10,2)"
        - name: "prs_opened"
          type: "INT"
        - name: "prs_merged"
          type: "INT"
        - name: "pr_throughput_per_week"
          type: "DECIMAL(10,2)"
        - name: "avg_review_time_hours"
          type: "DECIMAL(10,2)"
        - name: "p50_review_time_hours"
          type: "DECIMAL(10,2)"
        - name: "p95_review_time_hours"
          type: "DECIMAL(10,2)"
        - name: "lines_added"
          type: "BIGINT"
        - name: "lines_deleted"
          type: "BIGINT"
        - name: "code_churn_rate"
          type: "DECIMAL(10,4)"
        - name: "active_developers"
          type: "INT"
        - name: "calculated_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["repo_id", "week_start"]
        - columns: ["week_start"]

    - name: "velocity_user_weekly"
      schema: "org_{org_id}"
      description: "Metricas de Velocity por usuario por semana"
      columns:
        - name: "id"
          type: "UUID"
          primary_key: true
        - name: "github_user_id"
          type: "BIGINT"
        - name: "github_login"
          type: "VARCHAR(100)"
        - name: "week_start"
          type: "DATE"
          nullable: false
        - name: "commits_count"
          type: "INT"
        - name: "prs_opened"
          type: "INT"
        - name: "prs_merged"
          type: "INT"
        - name: "lines_added"
          type: "BIGINT"
        - name: "lines_deleted"
          type: "BIGINT"
        - name: "reviews_given"
          type: "INT"
        - name: "avg_review_time_hours"
          type: "DECIMAL(10,2)"
          description: "Time to give reviews"
        - name: "calculated_at"
          type: "TIMESTAMP"
          default: "CURRENT_TIMESTAMP"
      indexes:
        - columns: ["github_login", "week_start"]
          unique: true
        - columns: ["week_start"]

  # ========== VIEWS ==========
  views:
    - name: "v_copilot_trend"
      schema: "org_{org_id}"
      description: "Trend de metricas Copilot"
      definition: |
        SELECT date, total_active_users, acceptance_rate,
               LAG(acceptance_rate) OVER (ORDER BY date) as prev_acceptance_rate
        FROM copilot_daily_metrics
        ORDER BY date DESC

    - name: "v_dora_summary"
      schema: "org_{org_id}"
      description: "Resumo DORA por repositorio"
      definition: |
        SELECT r.name as repo_name, d.*
        FROM dora_weekly_metrics d
        JOIN repositories r ON d.repo_id = r.id
        WHERE d.week_start = (SELECT MAX(week_start) FROM dora_weekly_metrics)

  # ========== POWERBI NOTES ==========
  powerbi_integration:
    connection_type: "Direct Query"
    recommended_tables:
      - "copilot_daily_metrics"
      - "copilot_user_metrics"
      - "dora_weekly_metrics"
      - "velocity_weekly_metrics"
      - "velocity_user_weekly"
    dimension_tables:
      - "organizations"
      - "repositories"
    date_table: "Generate in PowerBI using CALENDAR()"
    refresh_schedule: "No refresh needed (Direct Query)"
    notes:
      - "Criar relacionamentos entre tabelas de fato e dimensoes"
      - "Usar RLS (Row Level Security) se necessario por org"
      - "Pre-agregar dados se performance for problema"
