---
# User Stories - GitHub Metrics Collector
# Generated by: requirements-analyst
# Phase: 2 (Requirements)
# Date: 2026-02-12T20:39:19Z

project:
  id: "metrics-collector-20260212"
  name: "GitHub Metrics Collector"

epics:
  - id: "EPIC-001"
    title: "Coleta de Metricas Copilot"
    description: "Coletar e armazenar metricas de uso do GitHub Copilot"

  - id: "EPIC-002"
    title: "Coleta de Metricas DORA"
    description: "Calcular metricas DORA a partir de dados do GitHub"

  - id: "EPIC-003"
    title: "Coleta de Metricas Velocity"
    description: "Coletar metricas de velocidade de desenvolvimento"

  - id: "EPIC-004"
    title: "Infraestrutura e Integracao"
    description: "Setup de banco de dados e integracao PowerBI"

  - id: "EPIC-005"
    title: "Gestao de Dados Historicos"
    description: "Importacao e gestao de dados desde 2023"

  - id: "EPIC-006"
    title: "Operacao e Manutencao"
    description: "Retry, backup, cleanup e alertas para operacao do sistema"

user_stories:

  # ========== EPIC-001: Metricas Copilot ==========

  - id: "US-001"
    epic: "EPIC-001"
    title: "Coletar Metricas Copilot de Organizacao"
    story: |
      Como Engenheiro de Dados
      Eu quero coletar metricas de uso do Copilot via API
      Para que eu possa analisar adocao da ferramenta

    acceptance_criteria:
      - id: "AC-001-01"
        given: "Dado que tenho token de API com permissao manage_billing:copilot"
        when: "Quando executo a coleta para uma organizacao"
        then: "Entao obtenho metricas diarias dos ultimos 30 dias"

      - id: "AC-001-02"
        given: "Dado que a organizacao tem menos de 5 usuarios Copilot"
        when: "Quando executo a coleta"
        then: "Entao recebo indicacao de dados insuficientes (privacy threshold)"

      - id: "AC-001-03"
        given: "Dado que a coleta foi bem sucedida"
        when: "Quando verifico os dados armazenados"
        then: "Entao vejo acceptance_rate, active_users, suggestions_shown, suggestions_accepted por dia"

    edge_cases:
      - scenario: "API retorna rate limit exceeded"
        expected_behavior: "Aguardar retry-after e tentar novamente com exponential backoff"
      - scenario: "Token expirado ou revogado"
        expected_behavior: "Logar erro, alertar, nao sobrescrever dados existentes"

    out_of_scope:
      - "Metricas em tempo real"
      - "Metricas por IDE (apenas agregado)"

    dependencies: []
    priority: must
    estimate: "M"
    sprint: 1

  - id: "US-002"
    epic: "EPIC-001"
    title: "Coletar Metricas Copilot por Usuario"
    story: |
      Como Engineering Manager
      Eu quero ver metricas de Copilot por desenvolvedor
      Para que eu possa identificar adocao individual

    acceptance_criteria:
      - id: "AC-002-01"
        given: "Dado que a coleta diaria foi executada"
        when: "Quando consulto os dados"
        then: "Entao vejo metricas individuais por usuario (github_login)"

      - id: "AC-002-02"
        given: "Dado que um usuario foi desativado"
        when: "Quando verifico o historico"
        then: "Entao ainda vejo os dados historicos do usuario"

    edge_cases:
      - scenario: "Usuario muda de nome (github_login)"
        expected_behavior: "Manter registro com user_id imutavel, atualizar login"

    out_of_scope:
      - "Metricas de chat/agents (apenas code completion)"

    dependencies:
      - "US-001"
    priority: must
    estimate: "S"
    sprint: 1

  - id: "US-003"
    epic: "EPIC-001"
    title: "Coletar Metricas Copilot por Linguagem"
    story: |
      Como Tech Lead
      Eu quero ver uso do Copilot por linguagem de programacao
      Para que eu possa entender onde a ferramenta e mais util

    acceptance_criteria:
      - id: "AC-003-01"
        given: "Dado que a coleta foi executada"
        when: "Quando consulto os dados"
        then: "Entao vejo breakdown por linguagem (Python, JavaScript, TypeScript, etc)"

      - id: "AC-003-02"
        given: "Dado que existe uma linguagem nao mapeada"
        when: "Quando verifico os dados"
        then: "Entao a linguagem aparece como 'Other' com contador"

    dependencies:
      - "US-001"
    priority: should
    estimate: "S"
    sprint: 1

  - id: "US-017"
    epic: "EPIC-001"
    title: "Coletar Metricas de Requests Premium Copilot"
    story: |
      Como Finance Manager
      Eu quero ver consumo de requests premium vs standard do Copilot
      Para que eu possa otimizar budget e prever gastos

    acceptance_criteria:
      - id: "AC-017-01"
        given: "Dado que tenho token de API com permissao apropriada"
        when: "Quando executo a coleta para uma organizacao"
        then: "Entao obtenho premium_requests_count e standard_requests_count por dia"

      - id: "AC-017-02"
        given: "Dado que a coleta foi bem sucedida"
        when: "Quando verifico os dados armazenados"
        then: "Entao vejo total_tokens_consumed, modelo usado (GPT-4, Claude, etc)"

      - id: "AC-017-03"
        given: "Dado que consulto os dados por periodo"
        when: "Quando gero o relatorio"
        then: "Entao vejo tendencia de uso premium vs standard ao longo do tempo"

      - id: "AC-017-04"
        given: "Dado que o usuario usou apenas requests standard"
        when: "Quando verifico os dados"
        then: "Entao premium_requests_count = 0"

    edge_cases:
      - scenario: "API nao retorna breakdown premium/standard"
        expected_behavior: "Logar warning, armazenar apenas total_requests se disponivel"
      - scenario: "Modelo usado nao identificado"
        expected_behavior: "Armazenar como 'unknown' com contador"

    out_of_scope:
      - "Previsao de custo em reais (apenas contagem de requests)"
      - "Alertas de limite de budget"

    technical_notes: |
      Endpoints provaveis:
      - GET /enterprises/{enterprise}/copilot/usage
      - GET /orgs/{org}/copilot/billing/seats (pode ter breakdown)
      Verificar documentacao oficial para campos disponiveis.

    dependencies:
      - "US-001"
    priority: must
    estimate: "M"
    sprint: 1

  # ========== EPIC-006: Operacao e Manutencao ==========

  - id: "US-018"
    epic: "EPIC-006"
    title: "Implementar Retry com Backoff Exponencial"
    story: |
      Como Operador do Sistema
      Eu quero que falhas transientes sejam tratadas automaticamente
      Para que a coleta seja resiliente sem intervencao manual

    acceptance_criteria:
      - id: "AC-018-01"
        given: "Dado que uma chamada de API falha"
        when: "Quando o erro e transiente (timeout, 429, 5xx)"
        then: "Entao o sistema tenta novamente ate 3 vezes com backoff"

      - id: "AC-018-02"
        given: "Dado que o retry falhou 3 vezes"
        when: "Quando verifico os logs"
        then: "Entao vejo o erro original e todas as tentativas"

      - id: "AC-018-03"
        given: "Dado que o retry teve sucesso na 2a tentativa"
        when: "Quando verifico os logs"
        then: "Entao vejo que a operacao foi completada com retry"

    edge_cases:
      - scenario: "Erro 401 (auth)"
        expected_behavior: "Nao tentar novamente, falhar imediatamente"

    dependencies: []
    priority: must
    estimate: "S"
    sprint: 1

  - id: "US-019"
    epic: "EPIC-006"
    title: "Exportar CSVs com Compressao GZIP"
    story: |
      Como Operador do Sistema
      Eu quero que exports sejam comprimidos
      Para que upload para OneDrive seja mais rapido e economize banda

    acceptance_criteria:
      - id: "AC-019-01"
        given: "Dado que a coleta foi completada"
        when: "Quando gero os exports"
        then: "Entao arquivos sao .csv.gz com ~80% menos tamanho"

      - id: "AC-019-02"
        given: "Dado que os arquivos foram copiados para OneDrive"
        when: "Quando PowerBI importa"
        then: "Entao PowerBI le .csv.gz nativamente sem erros"

    dependencies:
      - "US-001"
    priority: must
    estimate: "S"
    sprint: 1

  - id: "US-020"
    epic: "EPIC-006"
    title: "Cleanup Automatico de Arquivos Antigos"
    story: |
      Como Operador do Sistema
      Eu quero que arquivos antigos sejam removidos automaticamente
      Para que o disco nao fique cheio

    acceptance_criteria:
      - id: "AC-020-01"
        given: "Dado que existem JSON files com mais de 90 dias"
        when: "Quando o cleanup executa"
        then: "Entao arquivos antigos sao deletados"

      - id: "AC-020-02"
        given: "Dado que existem logs com mais de 30 dias"
        when: "Quando o cleanup executa"
        then: "Entao logs antigos sao deletados"

      - id: "AC-020-03"
        given: "Dado que o cleanup deletou arquivos"
        when: "Quando verifico os logs"
        then: "Entao vejo lista de arquivos removidos"

    dependencies: []
    priority: should
    estimate: "S"
    sprint: 2

  - id: "US-021"
    epic: "EPIC-006"
    title: "Alertas de Falhas via Power Automate"
    story: |
      Como Operador do Sistema
      Eu quero ser alertado quando a coleta falhar
      Para que eu possa investigar e corrigir

    acceptance_criteria:
      - id: "AC-021-01"
        given: "Dado que a coleta falhou 3 vezes consecutivas"
        when: "Quando o sistema detecta"
        then: "Entao dispara alerta via Power Automate"

      - id: "AC-021-02"
        given: "Dado que recebi um alerta"
        when: "Quando verifico o email"
        then: "Entao vejo data/hora, tipo de erro, e ultimas 3 tentativas"

    edge_cases:
      - scenario: "Power Automate indisponivel"
        expected_behavior: "Logar erro localmente, continuar operacao"

    dependencies: []
    priority: should
    estimate: "M"
    sprint: 3

  - id: "US-022"
    epic: "EPIC-006"
    title: "Backup Automatico do SQLite"
    story: |
      Como Operador do Sistema
      Eu quero que o banco de dados seja backupeado automaticamente
      Para que eu possa recuperar dados em caso de corrupcao

    acceptance_criteria:
      - id: "AC-022-01"
        given: "Dado que a coleta foi completada"
        when: "Quando o backup executa"
        then: "Entao copia do SQLite vai para OneDrive"

      - id: "AC-022-02"
        given: "Dado que e domingo"
        when: "Quando o dump semanal executa"
        then: "Entao gera metrics_dump_YYYYMMDD.sql.gz"

      - id: "AC-022-03"
        given: "Dado que existem backups com mais de 30 dias"
        when: "Quando verifico OneDrive"
        then: "Entao backups antigos foram sobrescritos"

    dependencies:
      - "US-012"
    priority: must
    estimate: "M"
    sprint: 2

  # ========== EPIC-002: Metricas DORA ==========

  - id: "US-004"
    epic: "EPIC-002"
    title: "Calcular Deployment Frequency"
    story: |
      Como Engineering Manager
      Eu quero saber quantas vezes deployamos por periodo
      Para que eu possa avaliar nossa frequencia de entrega

    acceptance_criteria:
      - id: "AC-004-01"
        given: "Dado que tenho repositorios com GitHub Actions"
        when: "Quando executo o calculo de DORA"
        then: "Entao obtenho deployment_frequency por repositorio por semana"

      - id: "AC-004-02"
        given: "Dado que um repositorio tem multiplos workflows"
        when: "Quando executo o calculo"
        then: "Entao considero apenas workflows marcados como 'deploy' (via label ou nome)"

      - id: "AC-004-03"
        given: "Dado que obtenho a metrica"
        when: "Quando verifico o resultado"
        then: "Entao vejo tambem a classificacao DORA (Elite, High, Medium, Low)"

    edge_cases:
      - scenario: "Repositorio sem deploys no periodo"
        expected_behavior: "Retornar 0 com classificacao 'Low'"
      - scenario: "Workflow falhou"
        expected_behavior: "Nao contar como deploy bem sucedido"

    dependencies: []
    priority: must
    estimate: "M"
    sprint: 2

  - id: "US-005"
    epic: "EPIC-002"
    title: "Calcular Lead Time for Changes"
    story: |
      Como Engineering Manager
      Eu quero saber quanto tempo leva do commit ao deploy
      Para que eu possa identificar gargalos no ciclo

    acceptance_criteria:
      - id: "AC-005-01"
        given: "Dado que tenho PRs merged na branch principal"
        when: "Quando executo o calculo de DORA"
        then: "Entao obtenho lead_time_for_changes em horas/dias"

      - id: "AC-005-02"
        given: "Dado que um PR teve multiplos commits"
        when: "Quando calculo lead time"
        then: "Entao uso o primeiro commit como inicio"

      - id: "AC-005-03"
        given: "Dado que obtenho a metrica"
        when: "Quando verifico o resultado"
        then: "Entao vejo media, P50, P95, e classificacao DORA"

    edge_cases:
      - scenario: "PR merged mas nao deployado ainda"
        expected_behavior: "Nao incluir no calculo ate deploy"
      - scenario: "Deploy direto sem PR"
        expected_behavior: "Calcular lead time do commit direto"

    dependencies:
      - "US-004"
    priority: must
    estimate: "M"
    sprint: 2

  - id: "US-006"
    epic: "EPIC-002"
    title: "Calcular Change Failure Rate"
    story: |
      Como Engineering Manager
      Eu quero saber qual percentual de deploys causam problemas
      Para que eu possa avaliar qualidade das entregas

    acceptance_criteria:
      - id: "AC-006-01"
        given: "Dado que tenho historico de deploys"
        when: "Quando executo o calculo"
        then: "Entao obtenho change_failure_rate como percentual"

      - id: "AC-006-02"
        given: "Dado que detectamos rollback"
        when: "Quando calculo failure rate"
        then: "Entao incremento o contador de falhas"

      - id: "AC-006-03"
        given: "Dado que uma issue foi linkada ao deploy"
        when: "Quando a issue tem label 'incident' ou 'hotfix'"
        then: "Entao incremento o contador de falhas"

    edge_cases:
      - scenario: "Nenhum deploy no periodo"
        expected_behavior: "Retornar null (nao calculavel)"
      - scenario: "Hotfix nao linkado a issue"
        expected_behavior: "Detectar pelo nome do branch (hotfix/*)"

    dependencies:
      - "US-004"
    priority: should
    estimate: "M"
    sprint: 2

  - id: "US-007"
    epic: "EPIC-002"
    title: "Estimar Mean Time to Recovery (MTTR)"
    story: |
      Como Engineering Manager
      Eu quero saber quanto tempo levamos para recuperar de falhas
      Para que eu possa avaliar resiliencia operacional

    acceptance_criteria:
      - id: "AC-007-01"
        given: "Dado que tenho issues com label 'incident'"
        when: "Quando executo o calculo"
        then: "Entao obtenho MTTR baseado em tempo open-to-closed"

      - id: "AC-007-02"
        given: "Dado que um incidente foi reaberto"
        when: "Quando calculo MTTR"
        then: "Entao uso o tempo total (soma dos periodos abertos)"

    edge_cases:
      - scenario: "Nenhum incidente no periodo"
        expected_behavior: "Retornar null com nota 'no incidents'"
      - scenario: "Incidente ainda aberto"
        expected_behavior: "Nao incluir no calculo de media"

    out_of_scope:
      - "Integracao com PagerDuty/OpsGenie"
      - "Deteccao automatica de incidentes"

    dependencies:
      - "US-004"
    priority: could
    estimate: "M"
    sprint: 3

  # ========== EPIC-003: Metricas Velocity ==========

  - id: "US-008"
    epic: "EPIC-003"
    title: "Calcular Commit Frequency"
    story: |
      Como Tech Lead
      Eu quero ver frequencia de commits por desenvolvedor
      Para que eu possa entender ritmo de trabalho

    acceptance_criteria:
      - id: "AC-008-01"
        given: "Dado que tenho repositorios monitorados"
        when: "Quando executo a coleta"
        then: "Entao obtenho commits_per_day por autor"

      - id: "AC-008-02"
        given: "Dado que um desenvolvedor usa emails diferentes"
        when: "Quando consolido os dados"
        then: "Entao agrupa pelo github_login (nao pelo email)"

    edge_cases:
      - scenario: "Commit por bot (dependabot, renovate)"
        expected_behavior: "Classificar separadamente como 'automated'"

    dependencies: []
    priority: must
    estimate: "M"
    sprint: 2

  - id: "US-009"
    epic: "EPIC-003"
    title: "Calcular PR Throughput"
    story: |
      Como Engineering Manager
      Eu quero ver quantos PRs sao merged por periodo
      Para que eu possa avaliar produtividade do time

    acceptance_criteria:
      - id: "AC-009-01"
        given: "Dado que tenho repositorios monitorados"
        when: "Quando executo a coleta"
        then: "Entao obtenho prs_merged_per_week por autor e repositorio"

      - id: "AC-009-02"
        given: "Dado que um PR foi fechado sem merge"
        when: "Quando calculo throughput"
        then: "Entao nao incluo no contador"

    dependencies:
      - "US-008"
    priority: must
    estimate: "S"
    sprint: 2

  - id: "US-010"
    epic: "EPIC-003"
    title: "Calcular Review Time"
    story: |
      Como Tech Lead
      Eu quero saber quanto tempo PRs esperam por review
      Para que eu possa identificar gargalos de code review

    acceptance_criteria:
      - id: "AC-010-01"
        given: "Dado que tenho PRs merged"
        when: "Quando executo o calculo"
        then: "Entao obtenho time_to_first_review em horas"

      - id: "AC-010-02"
        given: "Dado que obtenho a metrica"
        when: "Quando verifico os dados"
        then: "Entao vejo media, P50, P95 por repositorio"

    edge_cases:
      - scenario: "PR aprovado pelo autor (self-merge)"
        expected_behavior: "Marcar como 'self_merged', nao incluir em review time"

    dependencies:
      - "US-009"
    priority: should
    estimate: "M"
    sprint: 3

  - id: "US-011"
    epic: "EPIC-003"
    title: "Calcular Code Churn"
    story: |
      Como Tech Lead
      Eu quero ver quantidade de codigo adicionado vs removido
      Para que eu possa identificar refactoring e complexidade

    acceptance_criteria:
      - id: "AC-011-01"
        given: "Dado que tenho historico de commits"
        when: "Quando executo o calculo"
        then: "Entao obtenho lines_added, lines_deleted por periodo"

      - id: "AC-011-02"
        given: "Dado que obtenho as metricas"
        when: "Quando calculo churn rate"
        then: "Entao vejo (added + deleted) / total_lines como percentual"

    edge_cases:
      - scenario: "Arquivo binario modificado"
        expected_behavior: "Nao incluir no calculo de linhas"

    dependencies:
      - "US-008"
    priority: could
    estimate: "M"
    sprint: 3

  # ========== EPIC-004: Infraestrutura ==========

  - id: "US-012"
    epic: "EPIC-004"
    title: "Configurar Banco de Dados"
    story: |
      Como Engenheiro de Dados
      Eu quero um banco de dados para armazenar metricas
      Para que os dados fiquem disponiveis para analise

    acceptance_criteria:
      - id: "AC-012-01"
        given: "Dado que executo o setup"
        when: "Quando verifico o banco"
        then: "Entao tenho schemas separados por organizacao (org_a, org_b)"

      - id: "AC-012-02"
        given: "Dado que o banco esta configurado"
        when: "Quando verifico os indices"
        then: "Entao existem indices para date, user_id, repo_id"

    out_of_scope:
      - "Alta disponibilidade (HA)"
      - "Replicacao geografica"

    dependencies: []
    priority: must
    estimate: "M"
    sprint: 1

  - id: "US-013"
    epic: "EPIC-004"
    title: "Configurar Gestao de Segredos"
    story: |
      Como Engenheiro de Seguranca
      Eu quero que tokens de API fiquem em Key Vault
      Para que credenciais estejam protegidas

    acceptance_criteria:
      - id: "AC-013-01"
        given: "Dado que configuro a aplicacao"
        when: "Quando verifico variaveis de ambiente"
        then: "Entao nao existe token hardcoded"

      - id: "AC-013-02"
        given: "Dado que a aplicacao inicia"
        when: "Quando busca credenciais"
        then: "Entao le do Azure Key Vault via managed identity"

    edge_cases:
      - scenario: "Key Vault indisponivel"
        expected_behavior: "Logar erro, falhar fast, nao usar cache de secrets"

    dependencies:
      - "US-012"
    priority: must
    estimate: "S"
    sprint: 1

  - id: "US-014"
    epic: "EPIC-004"
    title: "Configurar Conexao PowerBI"
    story: |
      Como Analista de BI
      Eu quero conectar PowerBI ao banco de dados
      Para que eu possa criar dashboards

    acceptance_criteria:
      - id: "AC-014-01"
        given: "Dado que configuro Direct Query"
        when: "Quando conecto ao banco"
        then: "Entao vejo todas as tabelas de metricas"

      - id: "AC-014-02"
        given: "Dado que configuro credenciais"
        when: "Quando uso service principal"
        then: "Entao o acesso e read-only nas tabelas de metricas"

    dependencies:
      - "US-012"
    priority: must
    estimate: "S"
    sprint: 1

  - id: "US-015"
    epic: "EPIC-004"
    title: "Configurar Scheduling Automatico"
    story: |
      Como Engenheiro de Dados
      Eu quero que a coleta rode automaticamente todo dia
      Para que os dados estejam sempre atualizados

    acceptance_criteria:
      - id: "AC-015-01"
        given: "Dado que configuro o scheduler"
        when: "Quando verifico a execucao"
        then: "Entao a coleta roda diariamente as 06:00 UTC"

      - id: "AC-015-02"
        given: "Dado que a execucao falha"
        when: "Quando verifico alertas"
        then: "Entao recebo notificacao por email/Teams"

    edge_cases:
      - scenario: "Execucao anterior ainda rodando"
        expected_behavior: "Pular execucao, logar warning"

    dependencies:
      - "US-001"
      - "US-012"
    priority: must
    estimate: "M"
    sprint: 2

  # ========== EPIC-005: Dados Historicos ==========

  - id: "US-016"
    epic: "EPIC-005"
    title: "Importar Dados Historicos"
    story: |
      Como Engenheiro de Dados
      Eu quero importar dados desde 2023
      Para que eu tenha visao historica completa

    acceptance_criteria:
      - id: "AC-016-01"
        given: "Dado que tenho arquivos de dados antigos"
        when: "Quando executo a importacao"
        then: "Entao os dados sao validados e inseridos no banco"

      - id: "AC-016-02"
        given: "Dado que existem dados duplicados"
        when: "Quando executo a importacao"
        then: "Entao duplicatas sao detectadas e ignoradas"

      - id: "AC-016-03"
        given: "Dado que um arquivo tem formato invalido"
        when: "Quando executo a importacao"
        then: "Entao recebo relatorio de erros com linha e motivo"

    edge_cases:
      - scenario: "Formato de arquivo desconhecido"
        expected_behavior: "Rejeitar com erro explicativo"

    out_of_scope:
      - "Transformacao automatica de formatos"
      - "Backfill via API (muito antigo)"

    dependencies:
      - "US-012"
    priority: should
    estimate: "L"
    sprint: 3

summary:
  total_stories: 22
  by_priority:
    must: 15
    should: 5
    could: 2
  by_sprint:
    sprint_1: 9
    sprint_2: 7
    sprint_3: 4
    sprint_4: 2
  estimated_total: "M-L (approximately 4 sprints)"

  changelog:
    - date: "2026-02-12T21:15:00Z"
      change: "Added US-017 (Premium Requests Metrics) per user request"
      reason: "Budget optimization and cost prediction requirement"

    - date: "2026-02-12T21:45:00Z"
      change: "Added US-018 to US-022 (Operacao e Manutencao) per architecture revision"
      reason: "Local-first architecture requires retry, backup, cleanup, and alerts"
