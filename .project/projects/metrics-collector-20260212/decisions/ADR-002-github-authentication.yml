---
# Architecture Decision Record
# Generated by: adr-author
# Phase: 3 (Architecture)
# Date: 2026-02-12T20:46:44Z

decision:
  id: "ADR-002"
  title: "GitHub Authentication Strategy"
  status: "accepted"
  created_at: "2026-02-12T20:46:44Z"
  created_by: "system-architect"
  project: "metrics-collector-20260212"
  phase: 3

  context: |
    A aplicacao precisa autenticar com GitHub APIs para:
    1. Copilot Usage API (enterprise/org level) - requer permissoes especiais
    2. REST API (commits, PRs, releases, workflows)
    3. GraphQL API (bulk queries)

    Restricoes descobertas na Phase 1:
    - Enterprise Copilot endpoints NAO suportam fine-grained PATs
    - Enterprise Copilot endpoints NAO suportam GitHub App tokens
    - Rate limits: 5000 req/hour (PAT), 15000 req/hour (GitHub App)

    Opcoes avaliadas:
    - Personal Access Token (classic) apenas
    - GitHub App apenas
    - Hibrido: PAT para Copilot + GitHub App para repos

  decision: |
    Usar estrategia **hibrida**:

    1. **Classic PAT** para Copilot Usage API (enterprise-level)
       - Permissoes: manage_billing:copilot, read:enterprise
       - Um token por enterprise (total: 2 tokens)

    2. **GitHub App** para dados de repositorio (opcional, pode usar PAT)
       - Commits, PRs, workflows, releases
       - Uma instalacao por organizacao
       - Rate limit maior (15000/hour vs 5000/hour)

    Para simplicidade inicial, **usar apenas Classic PATs** para tudo:
    - 2 PATs (um por enterprise)
    - Escopo: manage_billing:copilot, repo, read:org

  rationale: |
    **Escolha simplificada (apenas PATs):**

    1. **Obrigatorio para Copilot**: Nao temos escolha - enterprise Copilot
       endpoints exigem classic PAT.

    2. **Simplicidade**: Usar mesmo tipo de auth para todas as APIs
       reduz complexidade de codigo e operacao.

    3. **Volume adequado**: 5000 req/hour e suficiente para nosso caso
       - Coleta diaria, nao real-time
       - Dezenas de repos, nao milhares

    4. **Rate limit**: Se necessario no futuro, migrar repos para GitHub App
       e manter PAT apenas para Copilot.

    **Por que NAO GitHub App para tudo:**
    - NAO funciona para Copilot enterprise endpoints (bloqueador)
    - Adiciona complexidade de gerenciar app + PAT
    - Beneficio de rate limit nao e critico para nosso volume

  consequences:
    positive:
      - Simplicidade: um tipo de autenticacao
      - Menos codigo: nao precisa trocar entre auth methods
      - Funciona garantido para Copilot API
    negative:
      - Rate limit menor (5000 vs 15000)
      - PAT atrelado a usuario (risco se usuario sair)
      - Expiracao de token requer rotacao manual
    mitigations:
      - "Criar PATs com conta de servico (nao usuario real)"
      - "Configurar alerta para tokens proximos de expirar"
      - "Documentar processo de rotacao"

  alternatives_considered:
    - option: "GitHub App para tudo"
      rejected_because: "Nao funciona para Copilot enterprise endpoints"

    - option: "Fine-grained PAT"
      rejected_because: "Nao suportado por enterprise Copilot endpoints"

    - option: "OAuth App"
      rejected_because: "Requer fluxo de autorizacao, inadequado para backend"

  implementation:
    steps:
      - "Criar conta de servico no GitHub Enterprise (se nao existe)"
      - "Gerar PAT para Enterprise 1 com escopos necessarios"
      - "Gerar PAT para Enterprise 2 com escopos necessarios"
      - "Armazenar PATs no Azure Key Vault"
      - "Configurar alerta de expiracao (30 dias antes)"
    estimated_effort: "1-2 horas"

    pat_configuration:
      name_pattern: "metrics-collector-{enterprise}-{date}"
      expiration: "90 dias (maximo recomendado)"
      scopes:
        - "manage_billing:copilot"
        - "repo"
        - "read:org"
        - "read:enterprise"

  validation:
    criteria:
      - "PATs funcionam para Copilot Usage API"
      - "PATs funcionam para REST API (commits, PRs)"
      - "Tokens armazenados no Key Vault"
      - "Rotacao documentada"

  security_considerations:
    - "PATs NUNCA em codigo ou config files"
    - "Usar Azure Key Vault com managed identity"
    - "Principio do menor privilegio nos escopos"
    - "Rotacao a cada 90 dias"
    - "Audit log de acesso aos secrets"

  references:
    - title: "GitHub REST API Authentication"
      url: "https://docs.github.com/en/rest/authentication"
    - title: "Copilot Metrics API Authentication"
      url: "https://docs.github.com/en/enterprise-cloud@latest/rest/copilot/copilot-metrics"

  tags:
    - "authentication"
    - "security"
    - "github"
    - "pat"
