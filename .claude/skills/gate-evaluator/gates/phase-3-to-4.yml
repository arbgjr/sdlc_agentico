# Gate: Phase 3 (Architecture) -> Phase 4 (Planning)
# Valida que arquitetura foi definida e decisoes documentadas

gate:
  name: "Architecture to Planning"
  from_phase: 3
  to_phase: 4
  description: "Valida que design de arquitetura esta completo"

required_artifacts:
  - name: "Architecture Overview"
    path: ".project/projects/*/architecture/*.md"
    fallback_path: ".specify/plans/*.md"
    description: "Documento de arquitetura de alto nivel"
    agent: "system-architect"

  - name: "ADRs"
    path: ".project/projects/*/decisions/adr-*.yml"
    fallback_path: "docs/adr/*.md"
    description: "Architecture Decision Records para decisoes significativas"
    agent: "adr-author"

  - name: "Technical Plan"
    path: ".project/projects/*/plans/*-technical-plan.md"
    fallback_path: ".specify/plans/*-technical-plan.md"
    description: "Plano tecnico detalhado"
    agent: "system-architect"

  - name: "Data Model"
    path: ".project/projects/*/data/*.md"
    fallback_path: "docs/data/*.md"
    description: "Modelo de dados e relacionamentos"
    agent: "data-architect"

  - name: "API Contracts"
    path: ".project/projects/*/api/*.yml"
    fallback_path: "docs/api/*.yml"
    description: "Contratos de API (OpenAPI/AsyncAPI)"
    agent: "data-architect"
    optional_for_levels: [0, 1]

  - name: "Threat Model"
    path: ".project/projects/*/security/threat-model*.yml"
    description: "Analise de ameacas STRIDE"
    agent: "threat-modeler"

quality_checks:
  - check: "Componentes definidos"
    validation: "grep -r 'components:' .project/projects/*/architecture/ .specify/plans/ 2>/dev/null | head -1"

  - check: "Tecnologias escolhidas"
    validation: "grep -r 'technology_choices:' .project/projects/*/architecture/ .specify/plans/ 2>/dev/null | head -1"

  - check: "NFRs enderecados"
    validation: "grep -r 'nfr_approach:' .project/projects/*/architecture/ .specify/plans/ 2>/dev/null | head -1"

  - check: "Trade-offs documentados"
    validation: "ls .project/projects/*/decisions/adr-*.yml docs/adr/*.md 2>/dev/null | head -1"

  - check: "Threat model realizado"
    validation: "grep -r 'threat_model:' .project/projects/*/security/2>/dev/null | head -1"

  - check: "Modelo de dados definido"
    validation: "grep -r 'entities:' .project/projects/*/data/ docs/data/ 2>/dev/null | head -1"

  - check: "Contratos de API especificados"
    validation: "ls .project/projects/*/api/*.yml docs/api/*.yml 2>/dev/null | head -1"

human_approval:
  required: true
  approvers:
    - role: "Tech Lead"
      reason: "Aprovacao de arquitetura"
    - role: "Security Lead"
      reason: "Se threat model identificou riscos altos"
    - role: "Data Lead"
      reason: "Se modelo de dados e complexo"

blockers:
  - "Arquitetura nao documentada"
  - "ADRs obrigatorios nao criados"
  - "Threat model nao realizado para sistemas criticos"
  - "NFRs nao enderecados"
  - "Modelo de dados nao definido"
  - "Contratos de API nao especificados"
  - "ODR de build vs buy nao aprovado (se aplicavel)"

# ODR checks para Level 2-3
odr_checks:
  - name: build_vs_buy_odr
    description: "ODR necessário para decisões de build vs buy"
    condition: "decisions.has_build_vs_buy == true"
    required_odr:
      category: "strategic"
      status: "approved"
    optional_for_levels: [0, 1]

  - name: significant_tradeoffs_odr
    description: "ODR necessário para trade-offs arquiteturais significativos"
    condition: "architecture.significant_tradeoffs == true"
    required_odr:
      category: "business"
      status: "approved"
    optional_for_levels: [0, 1]

stakeholder_review:
  description: "Arquivos que stakeholders devem revisar antes de prosseguir para Planning"
  notification: true
  reviewers:
    - role: tech_lead
      files:
        - pattern: ".project/projects/*/architecture/*.md"
          priority: high
          description: "Arquitetura de alto nivel"
        - pattern: ".project/projects/*/decisions/adr-*.yml"
          priority: high
          description: "Decisoes arquiteturais (ADRs)"
        - pattern: ".project/projects/*/plans/*-technical-plan.md"
          priority: high
          description: "Plano tecnico detalhado"
    - role: security_lead
      files:
        - pattern: ".project/projects/*/security/threat-model*.yml"
          priority: critical
          description: "Modelo de ameacas STRIDE"
    - role: data_lead
      files:
        - pattern: ".project/projects/*/data/*.md"
          priority: high
          description: "Modelo de dados"
        - pattern: ".project/projects/*/api/*.yml"
          priority: medium
          description: "Contratos de API"
  message_template: |
    ## Revisao de Fase 3 (Architecture) Necessaria

    Os seguintes arquivos de arquitetura precisam ser revisados:

    {{#each files}}
    - **{{this.description}}**: `{{this.pattern}}` (Prioridade: {{this.priority}})
    {{/each}}

    Por favor, revise e aprove para prosseguir para Planning.
